<?xml version="1.0" encoding="utf-8"?>
<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="https://github.com/avaloniaui/design"
        xmlns:vm="clr-namespace:OpenBroadcaster.Avalonia.ViewModels"
        xmlns:conv="clr-namespace:OpenBroadcaster.Avalonia.Converters"
        x:Class="OpenBroadcaster.Avalonia.Views.MainWindow"
        Title="OpenBroadcaster (Avalonia)"
        Width="1200" Height="820"
  Background="#0E1118"
  SystemDecorations="None">

  <Window.Resources>
    <conv:IsPlayingToBorderThicknessConverter x:Key="IsPlayingToBorderThicknessConverter" />
  </Window.Resources>

  <Grid Margin="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
    </Grid.RowDefinitions>

    <!-- Title bar / menu -->
    <Border Background="#0F2434" Padding="10" Grid.Row="0" CornerRadius="6">
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="Auto" />
          <ColumnDefinition Width="Auto" />
        </Grid.ColumnDefinitions>

        <Menu VerticalAlignment="Center">
          <MenuItem Header="_File">
            <MenuItem Header="Exit" Click="OnExitClick" />
          </MenuItem>
          <MenuItem Header="_Library">
            <MenuItem Header="Manage Categories..." Command="{Binding ManageCategoriesCommand}" />
            <Separator />
            <MenuItem Header="Import Tracks" Command="{Binding ImportTracksCommand}" />
            <MenuItem Header="Scan Folders" Command="{Binding ImportFolderCommand}" />
          </MenuItem>
          <MenuItem Header="_Help">
            <MenuItem Header="About OpenBroadcaster" Command="{Binding OpenAboutDialogCommand}" />
          </MenuItem>
        </Menu>

        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
          <Button Content="App Settings" Command="{Binding OpenAppSettingsCommand}" Width="140" Margin="8,0" />
        </StackPanel>

        <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="12,0,0,0">
          <Button Width="36" Height="24" Click="MinimizeButton_Click" Margin="0,0,6,0">_</Button>
          <Button Width="36" Height="24" Click="MaximizeRestoreButton_Click" Margin="0,0,6,0">â–¢</Button>
          <Button Width="36" Height="24" Click="CloseButton_Click" Background="#FFAA3333">X</Button>
        </StackPanel>
      </Grid>
    </Border>

    <!-- Main content area -->
    <Grid Grid.Row="1" Margin="0,16,0,0">
      <Grid.ColumnDefinitions>
        <ColumnDefinition Width="1.1*" />
        <ColumnDefinition Width="1.9*" />
      </Grid.ColumnDefinitions>

      <!-- Left Column: Library + Twitch -->
      <Border Grid.Column="0" Background="#0F1220" CornerRadius="8" Padding="12" Margin="0,0,14,0">
        <StackPanel>
          <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
            <TextBlock Text="Song Library" Foreground="#DDE7F3" FontSize="18" FontWeight="SemiBold" />
            <Border Background="#0F1218" BorderBrush="#2C6F9A" BorderThickness="0,0,0,2" Margin="12,0,0,0" Padding="6,2">
              <TextBlock Text="Ripped Graphite" Foreground="#2C6F9A" FontSize="12" />
            </Border>
          </StackPanel>

          <Grid Margin="0,12,0,12">
            <Grid.ColumnDefinitions>
              <ColumnDefinition Width="*" />
              <ColumnDefinition Width="260" />
            </Grid.ColumnDefinitions>
            <TextBox Grid.Column="0" Watermark="Search your library" Text="{Binding LibrarySearchText}" />
            <ComboBox Grid.Column="1" Items="{Binding LibraryCategories}" SelectedItem="{Binding SelectedLibraryCategory}">
              <ComboBox.ItemTemplate>
                <DataTemplate>
                  <TextBlock Text="{Binding Name}" />
                </DataTemplate>
              </ComboBox.ItemTemplate>
            </ComboBox>
          </Grid>

          <StackPanel Orientation="Horizontal" Spacing="8">
            <Button Content="Add to Queue" Command="{Binding AddToQueueCommand}" CommandParameter="{Binding SelectedLibraryItem}" />
            <Button Content="Assign Categories" Command="{Binding AssignCategoriesCommand}" />
            <Button Content="Import Files" Command="{Binding ImportTracksCommand}" />
            <Button Content="Import Folder" Command="{Binding ImportFolderCommand}" />
          </StackPanel>

          <TextBlock Margin="0,8,0,8" Foreground="#9AA6B3" Text="{Binding LibraryStatusMessage}" />

          <ListBox Items="{Binding LibraryItems}" SelectedItem="{Binding SelectedLibraryItem}" Height="260" Margin="0,6,0,0">
            <ListBox.ItemTemplate>
              <DataTemplate>
                <StackPanel Orientation="Horizontal" Spacing="8">
                  <TextBlock Text="{Binding Title}" Width="220" />
                  <TextBlock Text="{Binding Artist}" Width="140" Foreground="#9AA6B3" />
                  <TextBlock Text="{Binding Album}" Width="160" Foreground="#9AA6B3" />
                </StackPanel>
              </DataTemplate>
            </ListBox.ItemTemplate>
          </ListBox>

          <Border Background="#0E1118" BorderBrush="#2D313B" BorderThickness="1" CornerRadius="6" Margin="0,8,0,0" Padding="6" Height="120">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="120" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>
              <Border Width="100" Height="100" Background="#111318" CornerRadius="4" HorizontalAlignment="Left">
                <Image Source="{Binding SelectedLibraryItemArt}" Stretch="UniformToFill" />
              </Border>
              <StackPanel Grid.Column="1" Margin="8,0,0,0">
                <TextBlock Text="Selected Item Preview" Foreground="#DDE7F3" />
                <TextBlock Text="{Binding SelectedLibraryItem.Title}" Foreground="#9AA6B3" />
                <TextBlock Text="{Binding SelectedLibraryItem.Artist}" Foreground="#9AA6B3" />
              </StackPanel>
            </Grid>
          </Border>

          <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,12,0,0">
            <TextBlock Text="Twitch Chat" Foreground="#DDE7F3" FontSize="18" FontWeight="SemiBold" />
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="8,0,0,0">
              <TextBlock Text="Font" Foreground="#9AA6B3" Margin="4,0" VerticalAlignment="Center" />
              <Slider Minimum="8" Maximum="20" Value="{Binding TwitchChatFontSize, Mode=TwoWay}" Width="80" />
            </StackPanel>
          </StackPanel>

          <Border Background="#0E1118" BorderBrush="#2D313B" BorderThickness="1" CornerRadius="6" Margin="0,8,0,0" Padding="6">
            <ListBox Name="ChatList" Items="{Binding ChatMessages}" Height="180" Background="Transparent" BorderThickness="0">
              <ListBox.ItemTemplate>
                <DataTemplate>
                  <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding Timestamp}" Foreground="#7C8793" Margin="0,0,8,0" FontSize="{Binding DataContext.TwitchChatFontSize, RelativeSource={RelativeSource AncestorType=ListBox}}" />
                    <TextBlock Text="{Binding UserName}" FontWeight="SemiBold" Margin="0,0,8,0" FontSize="{Binding DataContext.TwitchChatFontSize, RelativeSource={RelativeSource AncestorType=ListBox}}" />
                    <TextBlock Text="{Binding Message}" TextWrapping="Wrap" FontSize="{Binding DataContext.TwitchChatFontSize, RelativeSource={RelativeSource AncestorType=ListBox}}" />
                  </StackPanel>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>
          </Border>
        </StackPanel>
      </Border>

      <!-- Right Column: Decks, Queue, Cart Wall -->
      <Grid Grid.Column="1">
        <Grid.RowDefinitions>
          <RowDefinition Height="Auto" />
          <RowDefinition Height="2*" />
          <RowDefinition Height="1*" />
        </Grid.RowDefinitions>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="0.7*" />
        </Grid.ColumnDefinitions>

        <!-- Deck A -->
        <Border Grid.Row="0" Grid.Column="0" Background="#0F1220" CornerRadius="8" Padding="12" Margin="0,0,8,8">
          <StackPanel>
            <TextBlock Text="Deck A" Foreground="#DDE7F3" FontSize="16" FontWeight="SemiBold" />
            <Grid Margin="0,6,0,0">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>
              <Border Width="80" Height="80" Background="#111318" CornerRadius="4" Margin="0,0,12,0">
                <Grid>
                  <Image Source="{Binding DeckA.AlbumArt}" Stretch="UniformToFill" />
                  <Border Background="#111318" IsVisible="{Binding DeckA.AlbumArt, Converter={x:Static conv:NullToBoolConverter.Instance}, ConverterParameter=inverse}">
                    <TextBlock Text="No Art" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#9AA6B3" />
                  </Border>
                </Grid>
              </Border>
              <StackPanel Grid.Column="1">
                <TextBlock Text="{Binding DeckA.Title}" />
                <TextBlock Text="{Binding DeckA.Artist}" Foreground="#9AA6B3" />
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Elapsed:" Foreground="#9AA6B3" />
                  <TextBlock Text="{Binding DeckA.ElapsedTime}" Foreground="#9AA6B3" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Remaining:" Foreground="#9AA6B3" />
                  <TextBlock Text="{Binding DeckA.RemainingTime}" Foreground="#9AA6B3" />
                </StackPanel>
              </StackPanel>
            </Grid>
            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
              <Button Content="Play" Width="80" Command="{Binding DeckPlayCommand}" CommandParameter="A" />
              <Button Content="Stop" Width="80" Command="{Binding DeckStopCommand}" CommandParameter="A" />
              <Button Content="Next" Width="80" Command="{Binding DeckNextCommand}" CommandParameter="A" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Deck B -->
        <Border Grid.Row="0" Grid.Column="1" Background="#0F1220" CornerRadius="8" Padding="12" Margin="8,0,8,8">
          <StackPanel>
            <TextBlock Text="Deck B" Foreground="#DDE7F3" FontSize="16" FontWeight="SemiBold" />
            <Grid Margin="0,6,0,0">
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
              </Grid.ColumnDefinitions>
              <Border Width="80" Height="80" Background="#111318" CornerRadius="4" Margin="0,0,12,0">
                <Grid>
                  <Image Source="{Binding DeckB.AlbumArt}" Stretch="UniformToFill" />
                  <Border Background="#111318" IsVisible="{Binding DeckB.AlbumArt, Converter={x:Static conv:NullToBoolConverter.Instance}, ConverterParameter=inverse}">
                    <TextBlock Text="No Art" HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="#9AA6B3" />
                  </Border>
                </Grid>
              </Border>
              <StackPanel Grid.Column="1">
                <TextBlock Text="{Binding DeckB.Title}" />
                <TextBlock Text="{Binding DeckB.Artist}" Foreground="#9AA6B3" />
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Elapsed:" Foreground="#9AA6B3" />
                  <TextBlock Text="{Binding DeckB.ElapsedTime}" Foreground="#9AA6B3" />
                </StackPanel>
                <StackPanel Orientation="Horizontal" Spacing="6">
                  <TextBlock Text="Remaining:" Foreground="#9AA6B3" />
                  <TextBlock Text="{Binding DeckB.RemainingTime}" Foreground="#9AA6B3" />
                </StackPanel>
              </StackPanel>
            </Grid>
            <StackPanel Orientation="Horizontal" Margin="0,8,0,0">
              <Button Content="Play" Width="80" Command="{Binding DeckPlayCommand}" CommandParameter="B" />
              <Button Content="Stop" Width="80" Command="{Binding DeckStopCommand}" CommandParameter="B" />
              <Button Content="Next" Width="80" Command="{Binding DeckNextCommand}" CommandParameter="B" />
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Control Rack -->
        <Border Grid.Row="0" Grid.Column="2" Grid.RowSpan="2" Background="#0F1220" CornerRadius="8" Padding="12" Margin="8,0,0,8">
          <StackPanel>
            <TextBlock Text="Control Rack" Foreground="#DDE7F3" FontSize="16" FontWeight="SemiBold" />
            <StackPanel Margin="0,8,0,0">
              <ToggleButton IsChecked="{Binding TwitchChatEnabled}">
                <StackPanel Orientation="Horizontal">
                  <Ellipse Width="10" Height="10" Margin="0,0,6,0" VerticalAlignment="Center"
                           Stroke="#2F343F" StrokeThickness="1"
                           Fill="{Binding TwitchChatEnabled, Converter={x:Static conv:BoolToBrushConverter.Instance}, ConverterParameter='#00FF00|#3A4252'}" />
                  <TextBlock Text="Enable Twitch" />
                </StackPanel>
              </ToggleButton>
              <ToggleButton IsChecked="{Binding AutoDjEnabled}" Margin="0,6,0,0">
                <StackPanel Orientation="Horizontal">
                  <Ellipse Width="10" Height="10" Margin="0,0,6,0" VerticalAlignment="Center"
                           Stroke="#2F343F" StrokeThickness="1"
                           Fill="{Binding AutoDjEnabled, Converter={x:Static conv:BoolToBrushConverter.Instance}, ConverterParameter='#00FF00|#3A4252'}" />
                  <TextBlock Text="Enable AutoDJ" />
                </StackPanel>
              </ToggleButton>
              <TextBlock Text="{Binding AutoDjStatusMessage}" Foreground="#9AA6B3" Margin="0,6,0,0" />
              <TextBlock Text="Levels" Foreground="#DDE7F3" FontSize="12" Margin="0,8,0,0" />
              <Grid Margin="0,6,0,0">
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Program / Main Output -->
                <StackPanel Grid.Row="0" Orientation="Vertical" Margin="0,0,0,8">
                  <TextBlock Text="Program" Foreground="#9AA6B3" />
                  <ProgressBar Minimum="0" Maximum="100" Value="{Binding ProgramVuPercent}" Height="12" Margin="0,6,0,6" />
                  <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                    <Slider Minimum="0" Maximum="100" Value="{Binding MasterVolume, Mode=TwoWay}" HorizontalAlignment="Stretch" Width="160" />
                    <TextBlock Text="{Binding MasterVolume, StringFormat='{}{0}%'}" Width="44" Foreground="#9AA6B3" Margin="8,0,0,0" VerticalAlignment="Center" />
                  </StackPanel>
                </StackPanel>

                <!-- Mic -->
                <StackPanel Grid.Row="1" Orientation="Vertical" Margin="0,0,0,8">
                  <TextBlock Text="Microphone" Foreground="#9AA6B3" />
                  <ProgressBar Minimum="0" Maximum="100" Value="{Binding MicVuPercent}" Height="12" Margin="0,6,0,6" />
                  <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                    <ToggleButton IsChecked="{Binding MicEnabled}" Width="56" Margin="0,0,8,0">
                      <StackPanel Orientation="Vertical" HorizontalAlignment="Center">
                        <Ellipse Width="10" Height="10" StrokeThickness="1" Margin="0,0,0,2" HorizontalAlignment="Center"
                                 Stroke="#2F343F"
                                 Fill="{Binding MicEnabled, Converter={x:Static conv:BoolToBrushConverter.Instance}, ConverterParameter='#00FF00|#3A4252'}" />
                        <TextBlock Text="Mic" VerticalAlignment="Center" HorizontalAlignment="Center" />
                      </StackPanel>
                    </ToggleButton>
                    <Slider Minimum="0" Maximum="100" Value="{Binding MicVolume}" Width="160" />
                    <TextBlock Text="{Binding MicVolume, StringFormat='{}{0}%'}" Width="44" Foreground="#9AA6B3" Margin="8,0,0,0" VerticalAlignment="Center" />
                  </StackPanel>
                </StackPanel>

                <!-- Cart Wall -->
                <StackPanel Grid.Row="2" Orientation="Vertical">
                  <TextBlock Text="Cart Wall" Foreground="#9AA6B3" />
                  <ProgressBar Minimum="0" Maximum="100" Value="{Binding CartVuPercent}" Height="12" Margin="0,6,0,6" />
                  <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                    <Slider Minimum="0" Maximum="100" Value="{Binding CartWallVolume, Mode=TwoWay}" Width="160" />
                    <TextBlock Text="{Binding CartWallVolume, StringFormat='{}{0}%'}" Width="44" Foreground="#9AA6B3" Margin="8,0,0,0" VerticalAlignment="Center" />
                  </StackPanel>
                </StackPanel>

                <!-- Encoder -->
                <StackPanel Grid.Row="3" Orientation="Vertical">
                  <TextBlock Text="Encoder" Foreground="#9AA6B3" />
                  <ProgressBar Minimum="0" Maximum="100" Value="{Binding EncoderVuPercent}" Height="12" Margin="0,6,0,6" />
                  <StackPanel Orientation="Horizontal" HorizontalAlignment="Stretch">
                    <Slider Minimum="0" Maximum="100" Value="{Binding EncoderVolume, Mode=TwoWay}" Width="160" />
                    <TextBlock Text="{Binding EncoderVolume, StringFormat='{}{0}%'}" Width="44" Foreground="#9AA6B3" Margin="8,0,0,0" VerticalAlignment="Center" />
                  </StackPanel>
                </StackPanel>
              </Grid>
            </StackPanel>
          </StackPanel>
        </Border>

        <!-- Queue (spans columns 0-1, below decks) -->
        <Border Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" Background="#0F1220" CornerRadius="8" Padding="12" Margin="0,0,8,8">
          <Grid>
            <Grid.RowDefinitions>
              <RowDefinition Height="Auto" />
              <RowDefinition Height="*" />
            </Grid.RowDefinitions>
            <StackPanel Grid.Row="0" Orientation="Horizontal" VerticalAlignment="Center">
              <TextBlock Text="Program Queue" Foreground="#DDE7F3" FontSize="16" FontWeight="SemiBold" />
              <Button Content="Shuffle" Command="{Binding ShuffleQueueCommand}" Margin="12,0,0,0" />
              <Button Content="Clear" Command="{Binding ClearQueueCommand}" Margin="8,0,0,0" />
            </StackPanel>

            <ListBox Grid.Row="1" Items="{Binding QueueItems}" SelectedItem="{Binding SelectedQueueItem}" Margin="0,12,0,0">
              <ListBox.ItemTemplate>
                <DataTemplate>
                  <Border Background="#121826" Padding="10" CornerRadius="5" Margin="0,4">
                    <Grid>
                      <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                      </Grid.ColumnDefinitions>
                      <StackPanel Grid.Column="0">
                        <TextBlock Text="{Binding Title}" FontWeight="SemiBold" />
                        <TextBlock Text="{Binding Artist}" Foreground="#9AA6B3" />
                      </StackPanel>
                      <Button Grid.Column="1" Content="Remove" Command="{Binding DataContext.RemoveQueueItemCommand, RelativeSource={RelativeSource AncestorType=ListBox}}" CommandParameter="{Binding}" Width="80" />
                    </Grid>
                  </Border>
                </DataTemplate>
              </ListBox.ItemTemplate>
            </ListBox>
          </Grid>
        </Border>

        <!-- Cart Wall -->
        <Border Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3" Background="#0F1220" CornerRadius="8" Padding="12" Margin="0,0,0,4">
          <StackPanel>
            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
              <TextBlock Text="Cart Wall" Foreground="#DDE7F3" FontSize="16" FontWeight="SemiBold" />
              <TextBlock Text="Hot triggers" Foreground="#9AA6B3" Margin="12,0,0,0" />
              <!-- Cart wall volume is shown in Control Rack -->
            </StackPanel>

            <ItemsControl Items="{Binding CartPads}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <WrapPanel ItemWidth="140" ItemHeight="80" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate>
                  <Button Command="{Binding DataContext.TriggerCartCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}" CommandParameter="{Binding}" Margin="6" Background="{Binding ColorHex}" CornerRadius="6" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" BorderBrush="#00FF00" BorderThickness="{Binding IsPlaying, Converter={StaticResource IsPlayingToBorderThicknessConverter}}" x:Name="CartButton">
                    <Button.ContextMenu>
                      <ContextMenu>
                        <MenuItem Header="Assign File..." Click="OnAssignFile" Tag="{Binding #CartButton.DataContext}" />
                        <MenuItem Header="Clear" Click="OnClearPad" Tag="{Binding #CartButton.DataContext}" />
                      </ContextMenu>
                    </Button.ContextMenu>
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                      <TextBlock Text="{Binding Label}" FontWeight="SemiBold" FontSize="14" HorizontalAlignment="Center" />
                      <TextBlock Text="{Binding Hotkey}" Foreground="#9AA6B3" FontSize="12" HorizontalAlignment="Center" />
                      <TextBlock Text="{Binding RemainingTimeDisplay}" Foreground="#00FF00" FontSize="16" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,4,0,0" />
                    </StackPanel>
                  </Button>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
          </StackPanel>
        </Border>
      </Grid>
    </Grid>
  </Grid>
</Window>
